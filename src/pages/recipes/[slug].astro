---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ScalableIngredients from '../../components/ScalableIngredients.jsx';
import FavoriteButton from '../../components/FavoriteButton.jsx';
import RecipeInstructions from '../../components/RecipeInstructions.jsx';
import RemixButton from '../../components/RemixButton.jsx';
import fs from 'fs';
import path from 'path';

export async function getStaticPaths() {
  const dataPath = path.join(process.cwd(), 'recipe-data', 'all-recipes.json');
  const data = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));

  return data.recipes.map((recipe: any) => ({
    params: { slug: recipe.slug },
    props: { recipe },
  }));
}

const { recipe } = Astro.props;

// Generate schema.org structured data for SEO
const schemaData = {
  "@context": "https://schema.org/",
  "@type": "Recipe",
  "name": recipe.title,
  "image": recipe.image ? [recipe.image] : [],
  "prepTime": recipe.prepTime ? `PT${recipe.prepTime.replace(/\s/g, '').toUpperCase()}` : undefined,
  "cookTime": recipe.cookTime ? `PT${recipe.cookTime.replace(/\s/g, '').toUpperCase()}` : undefined,
  "recipeYield": recipe.servings,
  "recipeIngredient": recipe.ingredients,
  "recipeInstructions": recipe.instructions.map((step: string, i: number) => ({
    "@type": "HowToStep",
    "position": i + 1,
    "text": step
  }))
};
---

<BaseLayout
  title={`${recipe.title} - Simpler Recipes`}
  description={`${recipe.title}. ${recipe.prepTime ? `Prep: ${recipe.prepTime}.` : ''} ${recipe.cookTime ? `Cook: ${recipe.cookTime}.` : ''} ${recipe.servings ? `Serves ${recipe.servings}.` : ''}`}
  image={recipe.image}
  type="article"
>
  <Fragment slot="head">
    <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  </Fragment>

  <main id="main-content" class="min-h-screen bg-background">
    <div class="max-w-[1080px] mx-auto px-4 py-8 md:py-12">
      <!-- Back navigation -->
      <nav class="mb-6 print:hidden">
        <a
          href="/"
          class="inline-flex items-center text-sand-600 hover:text-sand-900 transition-colors text-sm"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7" />
          </svg>
          <span class="ml-1">Back</span>
        </a>
      </nav>

      <!-- Two-column layout for desktop -->
      <div class="lg:grid lg:grid-cols-[1fr,340px] lg:gap-8 lg:items-start">
        <!-- Main content card (left) -->
        <article class="bg-sand-50 rounded-2xl overflow-hidden shadow-sm print:shadow-none print:rounded-none">
          {recipe.image && (
            <div class="aspect-[16/9] lg:aspect-[2/1] overflow-hidden bg-sand-200 print:hidden">
              <img
                src={recipe.image}
                alt={recipe.title}
                width={800}
                height={400}
                class="w-full h-full object-cover"
                loading="eager"
                decoding="async"
              />
            </div>
          )}

          <div class="p-6 md:p-8">
            <header class="mb-8 pb-6 border-b border-sand-200 print:border-sand-300">
              <div class="flex items-start justify-between gap-4 mb-4">
                <h1 class="text-2xl md:text-3xl font-medium tracking-tight-headline text-sand-900">
                  {recipe.title}
                </h1>
                <FavoriteButton client:load slug={recipe.slug} size="large" className="flex-shrink-0 print:hidden" />
              </div>

              <div class="flex flex-wrap items-center gap-2">
                {recipe.prepTime && (
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-sand-200/60 text-sand-700 text-xs">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6l4 2m6-2a10 10 0 11-20 0 10 10 0 0120 0z" />
                    </svg>
                    Prep: {recipe.prepTime}
                  </span>
                )}
                {recipe.cookTime && (
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-sand-200/60 text-sand-700 text-xs">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6l4 2m6-2a10 10 0 11-20 0 10 10 0 0120 0z" />
                    </svg>
                    Cook: {recipe.cookTime}
                  </span>
                )}
                {recipe.servings && (
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-sand-200/60 text-sand-700 text-xs">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    {recipe.servings} servings
                  </span>
                )}
              </div>

              {recipe.source && (
                <p class="mt-4 text-xs text-sand-500">
                  Originally from{' '}
                  <a
                    href={recipe.source.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-sand-600 hover:text-sand-800 underline underline-offset-2"
                  >
                    {recipe.source.name}
                  </a>
                </p>
              )}
            </header>

            <!-- Instructions -->
            <RecipeInstructions
              client:load
              instructions={recipe.instructions}
              recipeName={recipe.title}
            />

            <!-- Actions -->
            <div class="mt-8 pt-6 border-t border-sand-200 print:hidden">
              <RemixButton client:load recipe={recipe} />
            </div>

            {recipe.tags && recipe.tags.length > 0 && (
              <footer class="mt-4 pt-4 border-t border-sand-200 print:hidden">
                <div class="flex flex-wrap gap-2">
                  {recipe.tags.map((tag: string) => (
                    <span class="px-2 py-0.5 text-xs text-sand-500 bg-sand-100 rounded-full">
                      {tag}
                    </span>
                  ))}
                </div>
              </footer>
            )}
          </div>
        </article>

        <!-- Ingredients sidebar (right) - shown below on mobile, sticky on desktop -->
        <aside class="mt-6 lg:mt-0 lg:sticky lg:top-8">
          <ScalableIngredients
            client:idle
            ingredients={recipe.ingredients}
            servings={recipe.servings}
          />
        </aside>
      </div>
    </div>
  </main>
</BaseLayout>
