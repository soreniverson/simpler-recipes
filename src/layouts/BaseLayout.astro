---
import Header from '../components/Header.jsx';
import fs from 'fs';
import path from 'path';

export interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  canonical?: string;
}

const {
  title,
  description = "Extract clean, ad-free recipes from any URL. No more scrolling through life stories.",
  image = "/og-default.png",
  type = "website",
  canonical
} = Astro.props;

const siteUrl = "https://simpler.recipes";
const fullImageUrl = image.startsWith('http') ? image : `${siteUrl}${image}`;
const canonicalUrl = canonical || Astro.url.href;

// Load recipes for header search
const dataPath = path.join(process.cwd(), 'recipe-data', 'all-recipes.json');
const data = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
const recipes = data.recipes;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={fullImageUrl} />
    <meta property="og:site_name" content="Simpler Recipes" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={canonicalUrl} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={fullImageUrl} />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600&display=swap" rel="stylesheet" />

    <!-- Theme initialization (must run before body renders to prevent flash) -->
    <script is:inline>
      (function() {
        const STORAGE_KEY = 'simpler-recipes-settings';
        let theme = 'system';
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored) {
            const settings = JSON.parse(stored);
            if (settings.theme) theme = settings.theme;
          }
        } catch {}

        const effectiveTheme = theme === 'system'
          ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
          : theme;

        if (effectiveTheme === 'dark') {
          document.documentElement.classList.add('dark');
        }
      })();
    </script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RJR6YF1HVL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-RJR6YF1HVL');
    </script>
  </head>
  <body class="bg-background text-sand-900 min-h-screen">
    <a href="#main-content" class="skip-link">
      Skip to main content
    </a>
    <Header client:load recipes={recipes} />
    <slot />
  </body>
</html>

<style is:global>
  @tailwind base;
  @tailwind components;
  @tailwind utilities;

  /* Light mode (default) */
  :root {
    --sand-25: #FDFCFB;
    --sand-50: #FAF9F7;
    --sand-100: #F5F4F1;
    --sand-200: #EBEAE6;
    --sand-300: #DDDCD7;
    --sand-400: #BEBDB7;
    --sand-500: #9A9994;
    --sand-600: #787772;
    --sand-700: #5C5B57;
    --sand-800: #3A3832;
    --sand-900: #1F1E1B;
    --sand-950: #0F0E0D;
    --primary: #5C5B57;
    --primary-light: #787772;
    --surface: #FAF9F7;
    --background: #FDFCFB;
    --shadow-color: rgba(58, 56, 50, 0.04);
  }

  /* Dark mode */
  :root.dark {
    --sand-25: #2a2926;
    --sand-50: #242321;
    --sand-100: #1e1d1b;
    --sand-200: #181716;
    --sand-300: #141311;
    --sand-400: #3a3835;
    --sand-500: #5a5854;
    --sand-600: #787672;
    --sand-700: #9d9c98;
    --sand-800: #c5c4c0;
    --sand-900: #e8e7e3;
    --sand-950: #f5f4f1;
    --primary: #9d9c98;
    --primary-light: #c5c4c0;
    --surface: #242321;
    --background: #141311;
    --shadow-color: rgba(0, 0, 0, 0.4);
  }

  html {
    font-size: 18px;
    line-height: 1.6;
  }

  .skip-link {
    @apply absolute -top-10 left-0 bg-primary text-sand-50 px-4 py-2 z-50;
    transition: top 0.3s;
  }

  .skip-link:focus {
    @apply top-0;
  }

  @media print {
    .no-print {
      display: none !important;
    }

    body {
      background: white !important;
      font-size: 12pt;
    }

    .print-only {
      display: block !important;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    h1 {
      font-size: 18pt;
      margin-bottom: 12pt;
    }

    h2 {
      font-size: 14pt;
      margin-top: 16pt;
      margin-bottom: 8pt;
    }

    ul, ol {
      margin-left: 18pt;
    }

    li {
      margin-bottom: 4pt;
    }
  }

  :focus-visible {
    @apply outline-2 outline-offset-2 outline-sand-950;
  }

  button, a {
    min-height: 44px;
    min-width: 44px;
  }
</style>
